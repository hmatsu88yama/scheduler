# 外勤調整システム

医員の外勤スケジュールを最適化するWebアプリケーションです。

## 機能

- **マスタ管理**: 医員・外勤先の登録・編集・削除、指名・優先度設定、日別設定（2人体制・休診）
- **希望入力**: 各医員が日程希望（○/△/×）・希望外勤先を入力
- **スケジュール自動生成**: 3つの最適化モード
  - 案A: 給与均等重視（報酬のばらつきを最小化）
  - 案B: 希望重視（医員の希望を優先）
  - 案C: 優先度重視（◎○×設定を優先）
- **手動調整**: 生成された案の個別スロットを手動で変更可能
- **確定・共有**: 案を比較して確定、CSV出力

## セットアップ

### 1. 依存パッケージのインストール

```bash
pip install -r requirements.txt
```

### 2. サンプルデータの投入（初回のみ）

```bash
python seed_data.py
```

### 3. アプリの起動

```bash
streamlit run app.py
```

ブラウザで `http://localhost:8501` が自動的に開きます。

## 使い方

### 管理者

1. ロール選択画面で「管理者としてログイン」を選択（初回はパスワード設定）
2. 「マスタ管理」タブで医員・外勤先を登録
3. 外勤先ごとに指名医員・優先度（◎○×）を設定
4. 必要に応じて日別設定（2人体制・休診）を設定
5. 「希望状況一覧」で全医員の入力状況を確認
6. 「スケジュール生成」で案を自動生成
7. 3つの案を比較し、必要に応じて手動調整して確定

### 医員

1. ロール選択画面で「医員としてログイン」を選択し、名前を選択
2. 「希望入力」タブで日程希望（○/△/×）と希望外勤先を入力
3. 「スケジュール確認」で確定後のスケジュールを閲覧

## 制約条件（自動考慮）

- 各外勤先に毎週/隔週で必要人数を割り当て（通常1人、2人体制対応）
- 休診に設定された日はスロットから除外
- 同一日に1人が複数の外勤先に行かない
- ×日（NG）には割り当てない、△日にはペナルティ付きで割り当て可
- ×外勤先には割り当てない、◎外勤先には月1回以上必須
- 祝日は自動除外
- 報酬のばらつき・外勤回数のばらつきを最小化
- 過去の全確定スケジュールの累計報酬を考慮

## ファイル構成

```
scheduler/
├── app.py                      メインエントリポイント（ログイン・ルーティング）
├── database.py                 データベース層
├── optimizer.py                スケジュール最適化エンジン（PuLP）
├── components/
│   ├── __init__.py
│   └── schedule_table.py      共通テーブル表示
├── pages/
│   ├── __init__.py
│   ├── admin_master.py        マスタ管理
│   ├── admin_preferences.py   希望状況一覧
│   ├── admin_generate.py      スケジュール生成
│   ├── admin_schedule.py      確定スケジュール確認
│   ├── doctor_input.py        医員希望入力
│   └── doctor_schedule.py     医員スケジュール確認
├── seed_data.py               テスト用データ投入
├── requirements.txt
├── DESIGN.md
└── README.md
```

## カスタマイズ

- **外勤先の頻度**: `weekly`, `biweekly_odd`, `biweekly_even`, `first_only`, `last_only`
- **最適化の重み**: `optimizer.py` の `solve_schedule()` 内で調整可能
- **データ保持期間**: `delete_old_schedules(months_to_keep=4)` で変更
